# Base image

### cleanroom will have added the following substitution patterns:
###  # TIMESTAMP:   timestamp of installation
###  # SYSTEM:      system name
###  # BASE_SYSTEM: system name of the base
###  # ROOT:        path to the systems filesystem root

# Set up some more substitutions:
set ARCH x86_64
set VENDOR org.archlinux.cleanroom

# sed is needed for locale-gen
pacstrap config=type-base/pacstrap.conf
    glibc gzip

    pacman

    sed shadow systemd

append /usr/lib/os-release <<<<
VERSION=${TIMESTAMP}
VERSION_ID=${TIMESTAMP}
>>>>

create /etc/motd <<<<For authorized use only...
>>>> force=True
copy /etc/motd /etc/issue
copy /etc/motd /etc/issue.net

create /etc/machine.info <<<<PRETTY_HOSTNAME="Some machine"
ICON_NAME="computer"
CHASSIS="server"
>>>>

# Make sure some files are gone so that they do not cause trouble later:
remove /etc/fstab /etc/machine-id /etc/machine.info /usr/bin/init force=True

# Remove unnecessary systemd-generators:
# Must keep fstab and cryptsetup generator for mkinitcpio
remove /usr/lib/system/system-generators/systemd-system-update-generator

# Remove unnecessary systemd-timers:
remove /usr/lib/systemd/system/timers.target.wants/shadow.timer

# Remove unnecessary systemd-services:
remove /usr/lib/systemd/system/*/ldconfig.service
       /usr/lib/systemd/system/ldconfig.service
       /usr/lib/systemd/system/*/systemd-hwdb-update.service
       /usr/lib/systemd/system/systemd-hwdb-update.service

# Clean out useless files in /etc/systemd/system:
# These files are already in /usr/lib/systemd/system/...
remove /etc/systemd/system/multi-user.target.wants/remote-fs.target
       /etc/systemd/system/getty.target.wants/getty@tty1.service
       /etc/systemd/system/multi-user.target.wants
       /etc/systemd/system/getty.target.wants

set_timezone Europe/Berlin
set_default_target multi-user.target
set_locales de_DE en_US

sed 's/^[ \\t#]*KillUserProcesses=.*$/KillUserProcesses=yes/' /etc/systemd/logind.conf

# Things to update/clean on export:
add_hook export 'Run ldconfig' run /usr/bin/ldconfig -X
add_hook export 'Remove ldconfig data' remove /usr/bin/ldconfig
add_hook export 'Update HWDB' run /usr/bin/systemd-hwdb --usr update
add_hook export 'Remove HWDB data' remove /usr/bin/systemd-hwdb
