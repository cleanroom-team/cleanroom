#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
@author: Tobias Hunger <tobias.hunger@gmail.com>
"""

if __name__ != '__main__':
    print('This file can not be imported.')
    exit(1)

from argparse import ArgumentParser

import cleanroom as cr
import cleanroom.printer
import sys

def parse_commandline(arguments):
    '''This function parses the command line options.
    '''
    parser = ArgumentParser(description='Cleanroom OS image script generator',
                            prog=arguments[0])
    parser.add_argument('--debug', action='store_true',
                        help='Show debug information')
    parser.add_argument('--verbose', action='count', help='Be verbose')
    
    parser.add_argument('--force', action='store_true',
                        help='Force continuation on non-critical errors.')

    parser.add_argument('--systemsdir', dest='system_dir', action='store',
                        help='Directory containing system definitions')
    parser.add_argument('--workdir', dest='work_dir', action='store',
                        help='Work area to create files in')

    parser.add_argument(dest='systems', nargs='+', metavar='<system>',
                        help='systems to create')

    parse_result = parser.parse_args(arguments[1:])

    return parse_result

args = parse_commandline(sys.argv)

pr = cleanroom.printer.Printer(args.verbose, args.debug)
pr.verbose('Verbose output enabled.')
pr.info('Info output enabled.')
pr.trace('Trace output enabled.')
pr.debug('Debug output enabled.')

generator = cr.Generator(args.system_dir, args.work_dir, pr)
try:
    generator.preflightCheck()
except cr.PreflightError:
    if not args.force: sys.exit(1)

for s in args.systems:
    generator.addSystem(s)

generator.prepare()
generator.generate()

pr.verbose('Done.')
